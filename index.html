<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Board</title>
    <style>
        /* --- Styles --- */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            font-family: sans-serif; background-color: #333;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }

        #world { position: absolute; top: 0; left: 0; width: 0; height: 0; }

        #cork-bg {
            position: absolute; top: -50000px; left: -50000px; width: 100000px; height: 100000px;
            background-color: #bfa780;
            background-image: repeating-radial-gradient(#b09670 0, #bfa780 2px), repeating-radial-gradient(#a88e68 0, #bfa780 4px);
            background-size: 20px 20px;
            z-index: 0; pointer-events: auto; 
        }

        #yarn-layer {
            position: absolute; top: -50000px; left: -50000px; width: 100000px; height: 100000px;
            pointer-events: none; z-index: 1; overflow: visible;
        }

        line { stroke-width: 3; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3)); pointer-events: auto; }

        #controls {
            position: fixed; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; max-width: 90vw;
        }
        
        button {
            padding: 8px 12px; cursor: pointer; border: 1px solid #ccc; background: #fff;
            border-radius: 4px; font-weight: bold; white-space: nowrap;
        }
        button:hover { background: #eee; }
        button.active { background: #444; color: white; border-color: #222; }
        button.danger { border-color: #ffcccc; background: #fff0f0; color: #d00; }

        input[type="color"] { border: none; width: 35px; height: 35px; cursor: pointer; background: none; }

        /* --- Item Styles --- */
        .item {
            position: absolute; cursor: grab; box-shadow: 2px 5px 10px rgba(0,0,0,0.3);
            z-index: 10; min-width: 100px; min-height: 100px; transition: filter 0.2s;
        }
        .item:active { cursor: grabbing; z-index: 100; }

        /* --- THE NEW "CROSSED OUT" STYLES --- */
        .item.crossed-out::after {
            content: '';
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* Create a big red X using gradients */
            background: 
                linear-gradient(to top left, transparent 46%, #d00 46%, #d00 54%, transparent 54%),
                linear-gradient(to top right, transparent 46%, #d00 46%, #d00 54%, transparent 54%);
            pointer-events: none; /* Let clicks pass through so you can still drag it */
            opacity: 0.8;
            z-index: 50;
        }
        
        /* Grayscale only for photos */
        .photo.crossed-out img { filter: grayscale(100%); opacity: 0.7; }
        /* Dim text notes slightly */
        .note.crossed-out textarea { color: #555; }

        .note {
            width: 200px; height: 200px; background: #fdfd96; padding: 10px;
            box-sizing: border-box; transform: rotate(-2deg);
        }

        textarea {
            width: 100%; height: 90%; background: transparent; border: none;
            resize: none; font-family: 'Courier New', Courier, monospace; font-size: 16px;
            outline: none; user-select: text; -webkit-user-select: text;
        }

        .photo {
            width: 220px; background: white; padding: 10px 10px 40px 10px;
            transform: rotate(3deg); display: flex; flex-direction: column;
        }

        .photo img {
            width: 100%; height: 100%; object-fit: cover; pointer-events: none;
            display: block; background: #000; flex-grow: 1; transition: filter 0.2s;
        }

        .resizer {
            width: 15px; height: 15px; background: linear-gradient(135deg, transparent 50%, #999 50%);
            position: absolute; right: 0; bottom: 0; cursor: nwse-resize; z-index: 20;
        }

        #file-input, #import-file { display: none; }
        
        #context-menu {
            display: none; position: absolute; z-index: 2000; background: white;
            border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px; border-radius: 4px; min-width: 150px;
        }
        
        #context-menu button {
            display: block; width: 100%; text-align: left; border: none; background: none;
            padding: 8px 10px; cursor: pointer; font-size: 14px;
        }
        #context-menu button:hover { background-color: #eee; }
        
        #zoom-level { font-size: 12px; color: #666; min-width: 40px; text-align: right; }

    </style>
</head>
<body>

    <div id="controls">
        <button onclick="addNote()">+ Note</button>
        <button onclick="document.getElementById('file-input').click()">+ Photo</button>
        
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>
        
        <input type="color" id="yarn-color" value="#d94e4e" title="Choose Yarn Color">
        <button id="link-btn" onclick="toggleLinkMode()">üîó Link / Unlink</button>
        
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>
        
        <button onclick="resetView()">Reset View</button>
        <span id="zoom-level">100%</span>

        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>

        <button onclick="exportBoard()">‚¨á Export</button>
        <button onclick="document.getElementById('import-file').click()">‚¨Ü Import</button>

        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>

        <button class="danger" onclick="clearBoard()">üóëÔ∏è Clear</button>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
        <input type="file" id="import-file" accept=".json" onchange="importBoard(this)">
        
        <span id="save-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
    </div>

    <div id="world">
        <div id="cork-bg"></div>
        <svg id="yarn-layer"></svg>
    </div>
    
    <div id="context-menu">
        <button onclick="toggleCrossOut()">‚ùå Cross Out / Restore</button>
        <div style="border-top: 1px solid #ddd; margin: 2px 0;"></div>
        <button onclick="deleteCurrentItem()" style="color: #d00;">üóëÔ∏è Delete Item</button>
    </div>

<script>
    const world = document.getElementById('world');
    const svgLayer = document.getElementById('yarn-layer');
    const bg = document.getElementById('cork-bg');
    const linkBtn = document.getElementById('link-btn');
    const colorPicker = document.getElementById('yarn-color');
    const saveStatus = document.getElementById('save-status');
    const contextMenu = document.getElementById('context-menu');
    const zoomDisplay = document.getElementById('zoom-level');

    // --- STATE ---
    let scale = 1, panX = 0, panY = 0;
    let isPanning = false, panStartX, panStartY;
    let isDragging = false, currentDragItem = null, dragOffsetX, dragOffsetY;
    let isResizing = false, currentResizeItem = null, resizeStartX, resizeStartY, startWidth, startHeight;
    let linkMode = false, linkStartItem = null;
    let contextMenuItem = null;
    let connections = [];

    // --- DB ---
    let db;
    const DB_NAME = "DetectiveDB";
    const STORE_NAME = "boardState";

    function initDB() {
        const request = indexedDB.open(DB_NAME, 2);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadBoard(); 
        };
    }

    // --- LOGIC ---

    function getBoardState() {
        const itemsData = [];
        document.querySelectorAll('.item').forEach(el => {
            let content = "";
            let type = "note";
            if (el.classList.contains('photo')) {
                type = "photo";
                content = el.querySelector('img').src;
            } else {
                content = el.querySelector('textarea').value;
            }
            itemsData.push({
                id: el.id, type: type,
                x: parseFloat(el.style.left),
                y: parseFloat(el.style.top),
                w: el.style.width, h: el.style.height,
                content: content,
                crossed: el.classList.contains('crossed-out') // Save Crossed State
            });
        });

        const linesData = connections.map(c => ({
            startId: c.start.id, endId: c.end.id, color: c.color
        }));

        return { items: itemsData, lines: linesData, view: { scale, panX, panY } };
    }

    function exportBoard() {
        const json = JSON.stringify(getBoardState());
        const blob = new Blob([json], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "detective-board-" + Date.now() + ".json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importBoard(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("Replace current board?")) {
                        rebuildBoard(data);
                        saveBoard();
                    }
                } catch (err) { alert("Invalid File"); }
            };
            reader.readAsText(input.files[0]);
        }
        input.value = '';
    }

    function saveBoard() {
        if (!db) return;
        const transaction = db.transaction([STORE_NAME], "readwrite");
        transaction.objectStore(STORE_NAME).put(getBoardState(), "currentSave");
        transaction.oncomplete = () => {
             saveStatus.innerText = "Saved"; 
             setTimeout(() => saveStatus.innerText = "", 1000);
        };
    }

    function loadBoard() {
        const transaction = db.transaction([STORE_NAME], "readonly");
        const request = transaction.objectStore(STORE_NAME).get("currentSave");
        request.onsuccess = function(event) {
            if (event.target.result) rebuildBoard(event.target.result);
            else resetView();
        };
    }

    function rebuildBoard(data) {
        document.querySelectorAll('.item').forEach(e => e.remove());
        while(svgLayer.firstChild) svgLayer.removeChild(svgLayer.firstChild);
        connections = [];

        if (data.view) {
            scale = data.view.scale || 1;
            panX = data.view.panX || 0;
            panY = data.view.panY || 0;
            updateView();
        }

        data.items.forEach(item => {
            let el;
            if (item.type === 'note') el = createNoteElement(item.id, item.x, item.y, item.content, item.w, item.h);
            else el = createPhotoElement(item.id, item.x, item.y, item.content, item.w, item.h);
            
            // Restore Crossed State
            if(item.crossed) el.classList.add('crossed-out');
        });

        if (data.lines) {
            data.lines.forEach(lineData => {
                const startEl = document.getElementById(lineData.startId);
                const endEl = document.getElementById(lineData.endId);
                if (startEl && endEl) createLine(startEl, endEl, lineData.color || "#d94e4e");
            });
        }
    }

    function clearBoard() {
        if(confirm("Delete everything?")) {
            const transaction = db.transaction([STORE_NAME], "readwrite");
            transaction.objectStore(STORE_NAME).delete("currentSave");
            location.reload();
        }
    }

    function updateView() {
        world.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        zoomDisplay.innerText = Math.round(scale * 100) + "%";
    }

    function resetView() {
        scale = 1; panX = window.innerWidth / 2; panY = window.innerHeight / 2;
        updateView(); saveBoard();
    }

    window.addEventListener('wheel', (e) => {
        if (e.target.tagName === 'TEXTAREA') return;
        e.preventDefault();
        scale = Math.min(Math.max(0.1, scale + (e.deltaY * -0.001)), 5);
        updateView(); saveBoard();
    }, { passive: false });

    bg.addEventListener('mousedown', (e) => {
        if (e.button !== 0 || linkMode) return;
        isPanning = true; panStartX = e.clientX - panX; panStartY = e.clientY - panY;
        bg.style.cursor = "grabbing";
    });

    document.addEventListener('mousemove', (e) => {
        if (isPanning) {
            panX = e.clientX - panStartX; panY = e.clientY - panStartY;
            updateView(); return;
        }
        if (isDragging && currentDragItem) {
            currentDragItem.style.left = `${(e.clientX - panX) / scale - dragOffsetX}px`;
            currentDragItem.style.top = `${(e.clientY - panY) / scale - dragOffsetY}px`;
            updateLinesConnectedTo(currentDragItem);
        }
        if (isResizing && currentResizeItem) {
            currentResizeItem.style.width = (startWidth + (e.clientX - resizeStartX) / scale) + 'px';
            currentResizeItem.style.height = (startHeight + (e.clientY - resizeStartY) / scale) + 'px';
            updateLinesConnectedTo(currentResizeItem);
        }
    });

    document.addEventListener('mouseup', () => {
        if (isPanning) { isPanning = false; bg.style.cursor = "default"; saveBoard(); }
        if (isDragging || isResizing) { if(currentDragItem) currentDragItem.style.zIndex = 10; saveBoard(); }
        isDragging = false; isResizing = false; currentDragItem = null; currentResizeItem = null;
    });

    function generateId() { return 'item-' + Date.now() + '-' + Math.floor(Math.random() * 1000); }

    function addNote() {
        createNoteElement(generateId(), (window.innerWidth/2 - panX)/scale - 100, (window.innerHeight/2 - panY)/scale - 100, "");
        saveBoard();
    }

    function createNoteElement(id, x, y, content, w, h) {
        const note = document.createElement('div');
        note.className = 'item note'; note.id = id;
        note.style.left = x + 'px'; note.style.top = y + 'px';
        if(w) note.style.width = w; if(h) note.style.height = h;
        
        const textArea = document.createElement('textarea');
        textArea.placeholder = "Type clues here..."; textArea.value = content;
        textArea.addEventListener('input', saveBoard);

        const resizer = document.createElement('div'); resizer.className = 'resizer';
        note.appendChild(textArea); note.appendChild(resizer);
        setupInteractions(note); setupResize(resizer, note);
        world.appendChild(note);
        return note;
    }

    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                createPhotoElement(generateId(), (window.innerWidth/2 - panX)/scale - 110, (window.innerHeight/2 - panY)/scale - 110, e.target.result);
                saveBoard();
            }
            reader.readAsDataURL(input.files[0]);
        }
        input.value = '';
    }

    function createPhotoElement(id, x, y, imgSrc, w, h) {
        const photoDiv = document.createElement('div');
        photoDiv.className = 'item photo'; photoDiv.id = id;
        photoDiv.style.left = x + 'px'; photoDiv.style.top = y + 'px';
        if(w) photoDiv.style.width = w; if(h) photoDiv.style.height = h;

        const img = document.createElement('img'); img.src = imgSrc;
        const resizer = document.createElement('div'); resizer.className = 'resizer';
        
        photoDiv.appendChild(img); photoDiv.appendChild(resizer);
        setupInteractions(photoDiv); setupResize(resizer, photoDiv);
        world.appendChild(photoDiv);
        return photoDiv;
    }

    function setupInteractions(item) {
        item.addEventListener('mousedown', (e) => {
            if (e.target.className === 'resizer') return;
            if (e.button === 2) return; 
            if (linkMode) { handleLinkClick(item); return; }
            if (e.target.tagName === 'TEXTAREA') return;

            isDragging = true; currentDragItem = item;
            dragOffsetX = (e.clientX - panX) / scale - parseFloat(item.style.left);
            dragOffsetY = (e.clientY - panY) / scale - parseFloat(item.style.top);
            item.style.zIndex = 100; closeContextMenu();
        });

        item.addEventListener('contextmenu', (e) => {
            e.preventDefault(); contextMenuItem = item;
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px'; contextMenu.style.top = e.pageY + 'px';
        });
    }

    function setupResize(resizer, item) {
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation(); isResizing = true; currentResizeItem = item;
            resizeStartX = e.clientX; resizeStartY = e.clientY;
            startWidth = parseFloat(document.defaultView.getComputedStyle(item).width);
            startHeight = parseFloat(document.defaultView.getComputedStyle(item).height);
        });
    }

    function closeContextMenu() { contextMenu.style.display = 'none'; contextMenuItem = null; }

    function toggleCrossOut() {
        if(contextMenuItem) {
            contextMenuItem.classList.toggle('crossed-out');
            saveBoard();
            closeContextMenu();
        }
    }

    function deleteCurrentItem() {
        if (contextMenuItem) {
            connections = connections.filter(c => {
                if (c.start === contextMenuItem || c.end === contextMenuItem) {
                    c.line.remove(); return false;
                }
                return true;
            });
            contextMenuItem.remove(); saveBoard(); closeContextMenu();
        }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu')) closeContextMenu();
    });

    function toggleLinkMode() {
        linkMode = !linkMode; linkStartItem = null;
        if (linkMode) {
            linkBtn.classList.add('active'); linkBtn.innerText = "Click 2 Items";
            world.style.cursor = "crosshair";
        } else {
            linkBtn.classList.remove('active'); linkBtn.innerText = "üîó Link / Unlink";
            world.style.cursor = "default";
            document.querySelectorAll('.item').forEach(i => i.style.outline = "none");
        }
    }

    function handleLinkClick(item) {
        if (!linkStartItem) {
            linkStartItem = item; item.style.outline = "3px solid " + colorPicker.value;
        } else {
            if (linkStartItem !== item) {
                const idx = connections.findIndex(c => (c.start === linkStartItem && c.end === item) || (c.start === item && c.end === linkStartItem));
                if (idx !== -1) { connections[idx].line.remove(); connections.splice(idx, 1); } 
                else { createLine(linkStartItem, item, colorPicker.value); }
                saveBoard();
            }
            linkStartItem.style.outline = "none"; linkStartItem = null; toggleLinkMode();
        }
    }

    function createLine(item1, item2, color) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.style.stroke = color; svgLayer.appendChild(line);
        const connection = { line: line, start: item1, end: item2, color: color };
        connections.push(connection); updateLinePosition(connection);
    }

    function updateLinePosition(c) {
        const off = 50000;
        c.line.setAttribute('x1', parseFloat(c.start.style.left) + c.start.offsetWidth/2 + off);
        c.line.setAttribute('y1', parseFloat(c.start.style.top) + c.start.offsetHeight/2 + off);
        c.line.setAttribute('x2', parseFloat(c.end.style.left) + c.end.offsetWidth/2 + off);
        c.line.setAttribute('y2', parseFloat(c.end.style.top) + c.end.offsetHeight/2 + off);
    }

    function updateLinesConnectedTo(item) {
        connections.forEach(conn => {
            if (conn.start === item || conn.end === item) updateLinePosition(conn);
        });
    }

    window.onload = initDB;

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Board</title>
    <style>
        /* --- Styles --- */
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            font-family: sans-serif;
            background-color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #world {
            position: absolute;
            top: 0;
            left: 0;
            width: 0; 
            height: 0;
        }

        #cork-bg {
            position: absolute;
            top: -50000px;
            left: -50000px;
            width: 100000px;
            height: 100000px;
            background-color: #bfa780;
            background-image: repeating-radial-gradient(#b09670 0, #bfa780 2px), repeating-radial-gradient(#a88e68 0, #bfa780 4px);
            background-size: 20px 20px;
            z-index: 0;
            pointer-events: auto; 
        }

        #yarn-layer {
            position: absolute;
            top: -50000px;
            left: -50000px;
            width: 100000px;
            height: 100000px;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        }

        line {
            stroke-width: 3;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap; /* Allows wrapping on small screens */
            max-width: 90vw;
        }
        
        button {
            padding: 8px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
        }

        button:hover { background: #eee; }
        
        button.active {
            background: #444;
            color: white;
            border-color: #222;
        }
        
        button.danger {
            border-color: #ffcccc;
            background: #fff0f0;
            color: #d00;
        }

        input[type="color"] {
            border: none;
            width: 35px;
            height: 35px;
            cursor: pointer;
            background: none;
        }

        /* --- Item Styles --- */
        .item {
            position: absolute;
            cursor: grab;
            box-shadow: 2px 5px 10px rgba(0,0,0,0.3);
            z-index: 10;
            min-width: 100px;
            min-height: 100px;
        }

        .item:active { cursor: grabbing; z-index: 100; }

        .note {
            width: 200px;
            height: 200px;
            background: #fdfd96;
            padding: 10px;
            box-sizing: border-box;
            transform: rotate(-2deg);
        }

        textarea {
            width: 100%;
            height: 90%;
            background: transparent;
            border: none;
            resize: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            outline: none;
            user-select: text;
            -webkit-user-select: text;
        }

        .photo {
            width: 220px;
            background: white;
            padding: 10px 10px 40px 10px;
            transform: rotate(3deg);
            display: flex;
            flex-direction: column;
        }

        .photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            display: block;
            background: #000;
            flex-grow: 1;
        }

        .resizer {
            width: 15px;
            height: 15px;
            background: linear-gradient(135deg, transparent 50%, #999 50%);
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 20;
        }

        #file-input, #import-file { display: none; }
        
        #context-menu {
            display: none;
            position: absolute;
            z-index: 2000;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 4px;
        }
        
        #context-menu button {
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            padding: 5px 10px;
        }
        #context-menu button:hover { background-color: #eee; }
        
        #zoom-level {
            font-size: 12px;
            color: #666;
            min-width: 40px;
            text-align: right;
        }

    </style>
</head>
<body>

    <div id="controls">
        <button onclick="addNote()">+ Note</button>
        <button onclick="document.getElementById('file-input').click()">+ Photo</button>
        
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>
        
        <input type="color" id="yarn-color" value="#d94e4e" title="Choose Yarn Color">
        <button id="link-btn" onclick="toggleLinkMode()">üîó Link</button>
        
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>
        
        <button onclick="resetView()">Reset View</button>
        <span id="zoom-level">100%</span>

        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>

        <button onclick="exportBoard()">‚¨á Export</button>
        <button onclick="document.getElementById('import-file').click()">‚¨Ü Import</button>

        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 5px;"></div>

        <button class="danger" onclick="clearBoard()">üóëÔ∏è Clear</button>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
        <input type="file" id="import-file" accept=".json" onchange="importBoard(this)">
        
        <span id="save-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
    </div>

    <div id="world">
        <div id="cork-bg"></div>
        <svg id="yarn-layer"></svg>
    </div>
    
    <div id="context-menu">
        <button onclick="deleteCurrentItem()">Delete Item</button>
    </div>

<script>
    const world = document.getElementById('world');
    const svgLayer = document.getElementById('yarn-layer');
    const bg = document.getElementById('cork-bg');
    const linkBtn = document.getElementById('link-btn');
    const colorPicker = document.getElementById('yarn-color');
    const saveStatus = document.getElementById('save-status');
    const contextMenu = document.getElementById('context-menu');
    const zoomDisplay = document.getElementById('zoom-level');

    // --- VIEWPORT STATE ---
    let scale = 1;
    let panX = 0;
    let panY = 0;
    
    let isPanning = false;
    let panStartX, panStartY;

    // --- ITEM STATE ---
    let isDragging = false;
    let currentDragItem = null;
    let dragOffsetX, dragOffsetY;

    let isResizing = false;
    let currentResizeItem = null;
    let resizeStartX, resizeStartY, startWidth, startHeight;

    let linkMode = false;
    let linkStartItem = null;
    let contextMenuItem = null;
    let connections = [];

    // --- 0. DATABASE ENGINE ---
    let db;
    const DB_NAME = "DetectiveDB";
    const STORE_NAME = "boardState";

    function initDB() {
        const request = indexedDB.open(DB_NAME, 2);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadBoard(); 
        };
    }

    // --- 1. Import / Export Logic ---

    function getBoardState() {
        // Collect all data into a JS object
        const itemsData = [];
        document.querySelectorAll('.item').forEach(el => {
            let content = "";
            let type = "note";
            if (el.classList.contains('photo')) {
                type = "photo";
                content = el.querySelector('img').src;
            } else {
                content = el.querySelector('textarea').value;
            }
            itemsData.push({
                id: el.id, type: type,
                x: parseFloat(el.style.left),
                y: parseFloat(el.style.top),
                w: el.style.width, h: el.style.height,
                content: content
            });
        });

        const linesData = connections.map(c => ({
            startId: c.start.id, endId: c.end.id, color: c.color
        }));

        const viewData = { scale: scale, panX: panX, panY: panY };
        return { items: itemsData, lines: linesData, view: viewData };
    }

    function exportBoard() {
        const data = getBoardState();
        const json = JSON.stringify(data);
        const blob = new Blob([json], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = "detective-board-" + Date.now() + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importBoard(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("This will replace your current board. Continue?")) {
                        rebuildBoard(data);
                        saveBoard(); // Save immediately to DB
                    }
                } catch (err) {
                    alert("Invalid File Format");
                    console.error(err);
                }
            };
            reader.readAsText(input.files[0]);
        }
        input.value = ''; // Reset
    }

    // --- 2. Saving System (DB) ---

    function saveBoard() {
        if (!db) return;
        const data = getBoardState(); // Use helper
        const transaction = db.transaction([STORE_NAME], "readwrite");
        transaction.objectStore(STORE_NAME).put(data, "currentSave");
        transaction.oncomplete = () => {
             saveStatus.innerText = "Saved"; 
             setTimeout(() => saveStatus.innerText = "", 1000);
        };
    }

    function loadBoard() {
        const transaction = db.transaction([STORE_NAME], "readonly");
        const request = transaction.objectStore(STORE_NAME).get("currentSave");
        request.onsuccess = function(event) {
            if (event.target.result) rebuildBoard(event.target.result);
            else resetView();
        };
    }

    function rebuildBoard(data) {
        // Clear
        document.querySelectorAll('.item').forEach(e => e.remove());
        while(svgLayer.firstChild) { svgLayer.removeChild(svgLayer.firstChild); }
        connections = [];

        // View
        if (data.view) {
            scale = data.view.scale || 1;
            panX = data.view.panX || 0;
            panY = data.view.panY || 0;
            updateView();
        }

        // Items
        data.items.forEach(item => {
            if (item.type === 'note') createNoteElement(item.id, item.x, item.y, item.content, item.w, item.h);
            else createPhotoElement(item.id, item.x, item.y, item.content, item.w, item.h);
        });

        // Lines
        if (data.lines) {
            data.lines.forEach(lineData => {
                const startEl = document.getElementById(lineData.startId);
                const endEl = document.getElementById(lineData.endId);
                if (startEl && endEl) createLine(startEl, endEl, lineData.color || "#d94e4e");
            });
        }
    }

    function clearBoard() {
        if(confirm("Delete everything?")) {
            const transaction = db.transaction([STORE_NAME], "readwrite");
            transaction.objectStore(STORE_NAME).delete("currentSave");
            location.reload();
        }
    }

    // --- 3. Viewport Logic ---

    function updateView() {
        world.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
        zoomDisplay.innerText = Math.round(scale * 100) + "%";
        // Do not auto-save on every drag frame, rely on mouseup
    }

    function resetView() {
        scale = 1;
        panX = window.innerWidth / 2; 
        panY = window.innerHeight / 2;
        updateView();
        saveBoard();
    }

    window.addEventListener('wheel', (e) => {
        if (e.target.tagName === 'TEXTAREA') return;
        e.preventDefault();
        const zoomSensitivity = 0.001;
        const delta = -e.deltaY * zoomSensitivity;
        const newScale = Math.min(Math.max(0.1, scale + delta), 5);
        scale = newScale;
        updateView();
        saveBoard(); // Save zoom state
    }, { passive: false });

    bg.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        if (linkMode) return;
        isPanning = true;
        panStartX = e.clientX - panX;
        panStartY = e.clientY - panY;
        bg.style.cursor = "grabbing";
    });

    // --- 4. Global Interaction ---

    document.addEventListener('mousemove', (e) => {
        if (isPanning) {
            panX = e.clientX - panStartX;
            panY = e.clientY - panStartY;
            updateView();
            return;
        }

        if (isDragging && currentDragItem) {
            const rawX = (e.clientX - panX) / scale;
            const rawY = (e.clientY - panY) / scale;
            currentDragItem.style.left = `${rawX - dragOffsetX}px`;
            currentDragItem.style.top = `${rawY - dragOffsetY}px`;
            updateLinesConnectedTo(currentDragItem);
        }

        if (isResizing && currentResizeItem) {
            const deltaX = (e.clientX - resizeStartX) / scale;
            const deltaY = (e.clientY - resizeStartY) / scale;
            currentResizeItem.style.width = (startWidth + deltaX) + 'px';
            currentResizeItem.style.height = (startHeight + deltaY) + 'px';
            updateLinesConnectedTo(currentResizeItem);
        }
    });

    document.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            bg.style.cursor = "default";
            saveBoard(); // Save pan position
        }
        if (isDragging || isResizing) {
            if(currentDragItem) currentDragItem.style.zIndex = 10;
            saveBoard();
        }
        isDragging = false;
        isResizing = false;
        currentDragItem = null;
        currentResizeItem = null;
    });

    // --- 5. Item Factory & Tools ---

    function generateId() { return 'item-' + Date.now() + '-' + Math.floor(Math.random() * 1000); }

    function addNote() {
        const x = (window.innerWidth/2 - panX) / scale - 100;
        const y = (window.innerHeight/2 - panY) / scale - 100;
        createNoteElement(generateId(), x, y, "");
        saveBoard();
    }

    function createNoteElement(id, x, y, content, w, h) {
        const note = document.createElement('div');
        note.className = 'item note';
        note.id = id;
        note.style.left = x + 'px';
        note.style.top = y + 'px';
        if(w) note.style.width = w;
        if(h) note.style.height = h;
        
        const textArea = document.createElement('textarea');
        textArea.placeholder = "Type clues here...";
        textArea.value = content;
        textArea.addEventListener('input', saveBoard);

        const resizer = document.createElement('div');
        resizer.className = 'resizer';

        note.appendChild(textArea);
        note.appendChild(resizer);
        setupInteractions(note);
        setupResize(resizer, note);
        world.appendChild(note);
    }

    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const x = (window.innerWidth/2 - panX) / scale - 110;
                const y = (window.innerHeight/2 - panY) / scale - 110;
                createPhotoElement(generateId(), x, y, e.target.result);
                saveBoard();
            }
            reader.readAsDataURL(input.files[0]);
        }
        input.value = '';
    }

    function createPhotoElement(id, x, y, imgSrc, w, h) {
        const photoDiv = document.createElement('div');
        photoDiv.className = 'item photo';
        photoDiv.id = id;
        photoDiv.style.left = x + 'px';
        photoDiv.style.top = y + 'px';
        if(w) photoDiv.style.width = w;
        if(h) photoDiv.style.height = h;

        const img = document.createElement('img');
        img.src = imgSrc;
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        
        photoDiv.appendChild(img);
        photoDiv.appendChild(resizer);
        setupInteractions(photoDiv);
        setupResize(resizer, photoDiv);
        world.appendChild(photoDiv);
    }

    function setupInteractions(item) {
        item.addEventListener('mousedown', (e) => {
            if (e.target.className === 'resizer') return;
            if (e.button === 2) return; 
            if (linkMode) { handleLinkClick(item); return; }
            if (e.target.tagName === 'TEXTAREA') return;

            isDragging = true;
            currentDragItem = item;
            
            const worldMouseX = (e.clientX - panX) / scale;
            const worldMouseY = (e.clientY - panY) / scale;
            dragOffsetX = worldMouseX - parseFloat(item.style.left);
            dragOffsetY = worldMouseY - parseFloat(item.style.top);
            
            item.style.zIndex = 100; 
            closeContextMenu();
        });

        item.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            contextMenuItem = item;
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        });
    }

    function setupResize(resizer, item) {
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation(); 
            isResizing = true;
            currentResizeItem = item;
            resizeStartX = e.clientX; 
            resizeStartY = e.clientY;
            startWidth = parseFloat(document.defaultView.getComputedStyle(item).width);
            startHeight = parseFloat(document.defaultView.getComputedStyle(item).height);
        });
    }

    function closeContextMenu() {
        contextMenu.style.display = 'none';
        contextMenuItem = null;
    }

    function deleteCurrentItem() {
        if (contextMenuItem) {
            connections = connections.filter(c => {
                if (c.start === contextMenuItem || c.end === contextMenuItem) {
                    c.line.remove(); return false;
                }
                return true;
            });
            contextMenuItem.remove();
            saveBoard();
            closeContextMenu();
        }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu')) closeContextMenu();
    });

    function toggleLinkMode() {
        linkMode = !linkMode;
        linkStartItem = null;
        if (linkMode) {
            linkBtn.classList.add('active');
            linkBtn.innerText = "Click 2 Items";
            world.style.cursor = "crosshair";
        } else {
            linkBtn.classList.remove('active');
            linkBtn.innerText = "üîó Link";
            world.style.cursor = "default";
            document.querySelectorAll('.item').forEach(i => i.style.outline = "none");
        }
    }

    function handleLinkClick(item) {
        if (!linkStartItem) {
            linkStartItem = item;
            item.style.outline = "3px solid " + colorPicker.value;
        } else {
            if (linkStartItem !== item) {
                createLine(linkStartItem, item, colorPicker.value);
                saveBoard();
            }
            linkStartItem.style.outline = "none";
            linkStartItem = null;
            toggleLinkMode();
        }
    }

    function createLine(item1, item2, color) {
        const exists = connections.some(c => 
            (c.start === item1 && c.end === item2) || (c.start === item2 && c.end === item1)
        );
        if(exists) return;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.style.stroke = color;
        svgLayer.appendChild(line);
        
        const connection = { line: line, start: item1, end: item2, color: color };
        connections.push(connection);
        updateLinePosition(connection);
    }

    function updateLinePosition(connection) {
        const x1 = parseFloat(connection.start.style.left) + connection.start.offsetWidth / 2;
        const y1 = parseFloat(connection.start.style.top) + connection.start.offsetHeight / 2;
        const x2 = parseFloat(connection.end.style.left) + connection.end.offsetWidth / 2;
        const y2 = parseFloat(connection.end.style.top) + connection.end.offsetHeight / 2;
        const offset = 50000;

        connection.line.setAttribute('x1', x1 + offset);
        connection.line.setAttribute('y1', y1 + offset);
        connection.line.setAttribute('x2', x2 + offset);
        connection.line.setAttribute('y2', y2 + offset);
    }

    function updateLinesConnectedTo(item) {
        connections.forEach(conn => {
            if (conn.start === item || conn.end === item) {
                updateLinePosition(conn);
            }
        });
    }

    window.onload = initDB;

</script>
</body>
</html>
</body>
</html>


